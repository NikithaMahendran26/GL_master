sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel"],function(e,t){"use strict";return e.extend("approvals.Component",{metadata:{manifest:"json"},init:function(){e.prototype.init.apply(this,arguments);this.setModel(new t([]),"initiatorModel");this.setModel(new t([]),"approverModel");this.setModel(new t([]),"commentModel");this.setModel(new t({editable:false,title:"",closeText:"Close"}),"ui");this._setupInboxActions();this._initFromInbox()},_setupInboxActions:function(){const e=this.getComponentData()?.startupParameters;if(!e?.inboxAPI){console.warn("Inbox API not available");return}const t=e.inboxAPI;t.addAction({action:"APPROVE",label:"Approve",type:"accept"},()=>this._onApprove());t.addAction({action:"REJECT",label:"Reject",type:"reject"},()=>this._onReject())},createContent:function(){this._mainView=sap.ui.view({id:"glTaskView",viewName:"approvals.view.approvals",type:"XML"});this._mainView.setModel(this.getModel("ui"),"ui");this._mainView.setModel(this.getModel("commentModel"),"commentModel");this._mainView.setModel(this.getModel("initiatorModel"),"initiatorModel");this._mainView.setModel(this.getModel("approverModel"),"approverModel");return this._mainView},_initFromInbox:function(){const e=this.getComponentData()?.startupParameters;if(!e?.taskModel){console.error("App not launched from Inbox");return}this.setModel(e.taskModel,"task");const t=e.taskModel.getData();console.log("Inbox Task Data",t);const o=t.TaskTitle||"";const n=o.split(" ")[0];if(!n){console.error("Request ID not found in task title",o);return}this._loadGL(n)},_loadGL:function(e){const o=this.getModel("mainServiceModel")||this.getModel();if(!o){console.error("OData model not found");return}const n=`/GlMasterRequests(requestId='${e}')`;o.read(n,{urlParameters:{$expand:"glMasterItems"},success:function(e){console.log("GL OData response",e);const o=new t({items:e.glMasterItems?.results||[]});if(this._mainView){this._mainView.setModel(o,"glModel")}else{this.setModel(o,"glModel")}}.bind(this),error:function(e){console.error("Failed to load GL request",e)}})},addApproverComment:function(e,t){const o=this.getModel("approverModel").getData();o.push({Text:e,UserName:t,Date:(new Date).toLocaleString()});this.getModel("approverModel").setData(o);this._mergeComments()},_mergeComments:function(){const e=[...this.getModel("initiatorModel").getData(),...this.getModel("approverModel").getData()];e.sort((e,t)=>new Date(t.Date)-new Date(e.Date));this.getModel("commentModel").setData(e)},_onApprove:async function(){try{const e=await this._postGLToSAP();if(!e.success){sap.m.MessageBox.error("SAP Error:\n"+e.error);return}sap.m.MessageToast.show("GL Account approved & created");this._completeWorkflowTask()}catch(e){sap.m.MessageBox.error(e.message||"Approval failed")}},_postGLToSAP:function(){return new Promise(e=>{const t=this.getModel("CreateGLServiceModel");if(!t){e({success:false,error:"CreateGLServiceModel not found"});return}const o=this._mainView?.getModel("glModel")||this.getModel("glModel");if(!o){e({success:false,error:"GL data model not available"});return}const n=o.getData();const s=n?.items?.[0];if(!s){e({success:false,error:"GL request data is empty"});return}const a={GLACCNO:s.GLAccount||"",CHACCTS:s.ChartOfAccounts||"",ACCGRP:s.AccountGroup||"",GLACCTYPE:s.GLAccountType||"",LANGUAGE:"EN",SHTEXT:s.ShortText||"",LGTEXT:s.GLAccountLongText||"",COMPCODE:s.CompanyCode||"",CURRENCY:s.AccountCurrency||"",FELDSTGRP:s.FieldStatusGroup||"",HOUSEBK:s.HouseBank||"",BALINLCLCURR:s.LocalCurrencyOnly===true?"X":"",TAXCATEGORY:s.TaxCategory||"",RECONACCT:s.ReconciliationAccount||"",SORTKEY:s.SortKey||"",PLACCT:s.PlanningAccount||"",BALSHEETINDI:s.BalanceSheetIndicator||"",TRADEPARTNO:s.TradingPartner||"",EXRTDIFFKEY:s.ExchangeRateDiffKey||"",ALTACCTNO:s.AlternateAccount||"",INFKEY:s.InflationKey||"",PSTWOTAX:s.PostWithoutTax||"",ACTMNGEXT:s.OpenItemManagement===true?"X":"",TOLGRP:s.ToleranceGroup||"",XLGCLR:s.LineItemDisplay||"",XOPVW:s.OpenItemView||"",AUTHGRP:s.AuthorizationGroup||"",CLERKABBV:s.ClerkAbbreviation||"",RECID:s.RecId||"",SUPAUTOPOST:s.SupplementAutoPost||"",RECONACTINPUT:s.ReconAccountInput||"",PLANLEVEL:s.PlanningLevel||"",CASHFLOWREL:s.CashFlowRelevant||"",COMMITITEM:s.CommitmentItem||"",ACCTID:s.AccountId||"",INTINDICATOR:s.InterestIndicator||"",INTCALCFREQ:s.InterestCalcFrequency||"",ZINDT:s.InterestKeyDate||"",DATLZ:s.LastInterestCalcDate||"",POSTAUTO:s.AutoPost||""};t.create("/ETY_CREATEGLSet",a,{success:function(){e({success:true})},error:function(t){let o="Unknown SAP error";try{const e=JSON.parse(t.responseText);o=e?.error?.message?.value||e?.error?.innererror?.errordetails?.[0]?.message||o}catch(e){}e({success:false,error:o})}})})},_fetchWorkflowToken:async function(){const e=await fetch("/bpmworkflowruntime/v1/xsrf-token",{method:"GET",headers:{"X-CSRF-Token":"Fetch"},credentials:"include"});return e.headers.get("X-CSRF-Token")},_completeWorkflowTask:async function(){const e=this._getWorkflowBaseURL();const t=this.getModel("task").getData().InstanceID;const o=await this._fetchWorkflowToken();const n=await fetch(`${e}/task-instances/${t}`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-Token":o},credentials:"include",body:JSON.stringify({status:"COMPLETED"})});if(!n.ok){throw new Error("Workflow task completion failed")}},_getWorkflowBaseURL:function(){return"/bpmworkflowruntime/v1"}})});
//# sourceMappingURL=Component.js.map